<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV to JSON 変換ツール</title>
    <!-- beer.cssへのパス -->
    <link rel="stylesheet" href="../beer.css">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <style>
        body {
            background-color: var(--surface);
            font-family: var(--font);
            padding: 1rem;
        }
        main {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: var(--surface-container-low);
            border-radius: 0.75rem;
            box-shadow: var(--elevate1);
        }
        .header-with-guide {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        #drop-area {
            border: 2px dashed var(--outline-variant);
            border-radius: 0.5rem;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            background-color: var(--surface-container-lowest);
            transition: background-color 0.2s, border-color 0.2s;
        }
        #drop-area.highlight {
            background-color: var(--primary-container);
            border-color: var(--primary);
        }
        #file-info {
            margin-top: 1rem;
            color: var(--on-surface-variant);
            min-height: 1.5rem; /* レイアウトがずれないように高さを確保 */
        }
        #json-output {
            width: 100%;
            height: 300px;
            font-family: monospace;
            font-size: 0.8rem;
            margin-top: 1rem;
            border: 1px solid var(--outline);
            border-radius: 0.25rem;
            padding: 0.5rem;
            background-color: var(--surface-container-lowest);
        }
        .grid-inputs {
            display: grid;
            grid-template-columns: 1fr; /* スマホでは1列 */
            gap: 1.5rem;
            margin-top: 1.5rem;
        }
        @media (min-width: 600px) {
            .grid-inputs {
                grid-template-columns: 1fr 1fr;
            }
        }
        main > p {
            margin-bottom: 2rem;
            color: var(--on-surface-variant);
        }

        /* ガイド用ダイアログのスタイル */
        #guide-dialog {
            max-width: 720px;
        }
        #guide-dialog header {
            padding-bottom: 1rem;
        }
        #guide-dialog main {
            padding: 0;
            box-shadow: none;
            margin: 0;
        }
        #guide-dialog table {
            margin-top: 1rem;
        }
        #guide-dialog code {
            background-color: var(--surface-variant);
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
        }
        #guide-dialog pre {
            background-color: var(--surface-variant);
            padding: 1rem;
            border-radius: 0.5rem;
            border-left: none;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .warning-box {
            background-color: var(--error-container);
            color: var(--on-error-container);
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1.5rem;
            border-left: 4px solid var(--error);
        }
        .warning-box h6 {
            margin-top: 0;
        }
        .prompt-box {
            background-color: var(--surface-container);
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1.5rem;
            border-left: 4px solid var(--primary);
        }
    </style>
</head>
<body>
    <main>
        <div class="header-with-guide">
            <h1>CSV to JSON 変換ツール</h1>
            <button class="chip" id="show-guide-btn">
                <i class="material-symbols-outlined">help_outline</i>
                <span>CSV作成ガイド</span>
            </button>
        </div>
        <p>問題データが記述されたCSVファイルをここにドラッグ＆ドロップするか、エリア内をクリックしてファイルを選択してください。</p>

        <div id="drop-area">
            <input type="file" id="file-input" accept=".csv" style="display: none;">
            <i class="material-symbols-outlined large-text">upload_file</i>
            <p>ここにファイルをドロップ</p>
        </div>
        <div id="file-info">ファイルが選択されていません</div>

        <div class="grid-inputs">
            <div class="field label border round">
                <input type="text" id="subject-id" placeholder=" ">
                <label>教科ID (例: math)</label>
            </div>
            <div class="field label border round">
                <input type="text" id="subject-title" placeholder=" ">
                <label>教科名 (例: 数学)</label>
            </div>
        </div>

        <div class="center-align" style="margin-top: 2rem;">
            <button class="responsive large-elevate" id="convert-btn" disabled>
                <span>変換</span>
                <i class="material-symbols-outlined">autorenew</i>
            </button>
        </div>

        <h5 style="margin-top: 2.5rem; margin-bottom: 0.5rem;">変換結果 (JSON)</h5>
        <textarea id="json-output" readonly placeholder="ここに変換後のJSONが表示されます"></textarea>

        <div class="center-align" style="margin-top: 1.5rem;">
            <button class="large" id="download-btn" disabled>
                <span>JSONファイルをダウンロード</span>
                <i class="material-symbols-outlined">download</i>
            </button>
        </div>
    </main>

    <dialog class="large-padding" id="guide-dialog">
        <header>
            <h5 class="max">CSV作成ガイド</h5>
            <button class="circle transparent" id="close-guide-btn">
                <i class="material-symbols-outlined">close</i>
            </button>
        </header>
        <main>
            <p>問題データは、ExcelやGoogle スプレッドシートなどの表計算ソフトで作成し、CSV形式で保存します。以下のルールに従って作成してください。</p>
            
            <h6>1. 基本ルール</h6>
            <ul>
                <li><strong>1教科につき1ファイル</strong>で作成します。（例: `math.csv`）</li>
                <li>1行目には、後述する**ヘッダー（列名）を正確に**記述してください。</li>
                <li>各行は「問題セットの定義」か「個別の問題」のどちらかになります。`row_type`列で指定します。</li>
            </ul>

            <h6>2. ヘッダー（1行目）</h6>
            <p>CSVファイルの1行目には、以下の11個の列名をカンマ区切りで正確に記述してください。</p>
            <pre><code>row_type,set_id,set_title,set_description,is_math,q_id,q_num,question_text,hint,answer,explanation</code></pre>

            <h6>3. 列の詳細</h6>
            <div class="responsive-table">
                <table>
                    <thead>
                        <tr>
                            <th>列名</th>
                            <th>必須</th>
                            <th>説明</th>
                            <th>入力例</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>row_type</code></td>
                            <td>✔</td>
                            <td>行の種類。<code>set</code> (問題セット) か <code>question</code> (問題) を指定。</td>
                            <td>set</td>
                        </tr>
                        <tr>
                            <td><code>set_id</code></td>
                            <td>setの時</td>
                            <td>問題セットのID。**英数字とハイフンのみ**。</td>
                            <td>math-curves-1</td>
                        </tr>
                        <tr>
                            <td><code>set_title</code></td>
                            <td>setの時</td>
                            <td>問題セットのタイトル。</td>
                            <td>二次曲線 (問題)</td>
                        </tr>
                        <tr>
                            <td><code>set_description</code></td>
                            <td>setの時</td>
                            <td>問題セットの説明文。</td>
                            <td>放物線や楕円の問題です。</td>
                        </tr>
                        <tr>
                            <td><code>is_math</code></td>
                            <td>setの時</td>
                            <td>数式を含むセットの場合 `TRUE` と入力。</td>
                            <td>TRUE</td>
                        </tr>
                        <tr>
                            <td><code>q_id</code></td>
                            <td>questionの時</td>
                            <td>各問題のID。**英数字とハイフンのみ**。</td>
                            <td>math-curves-q1</td>
                        </tr>
                        <tr>
                            <td><code>q_num</code></td>
                            <td>questionの時</td>
                            <td>問題番号。</td>
                            <td>問1</td>
                        </tr>
                        <tr>
                            <td><code>question_text</code></td>
                            <td>questionの時</td>
                            <td>問題文。改行は <code>&lt;br&gt;</code> を使用。</td>
                            <td>焦点が $F(2,0)$ で...</td>
                        </tr>
                        <tr>
                            <td><code>hint</code></td>
                            <td>(任意)</td>
                            <td>ヒントの文章。</td>
                            <td>標準形 $y^2 = 4px$ を...</td>
                        </tr>
                        <tr>
                            <td><code>answer</code></td>
                            <td>(任意)</td>
                            <td>解答。</td>
                            <td>`$y^2 = 8x$`</td>
                        </tr>
                        <tr>
                            <td><code>explanation</code></td>
                            <td>(任意)</td>
                            <td>解説文。</td>
                            <td>与えられた条件から p=2 ...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <h6>4. 入力例</h6>
            <p>`set`行で問題セットを定義し、その下に属する`question`行を続けます。</p>
            <pre><code>row_type,set_id,set_title,...
set,math-vectors-1,ベクトル,...
question,,,,,math-vectors-q1,V1-A1,2つのベクトルの内積...
question,,,,,math-vectors-q2,V1-A2,ベクトルの大きさを...
set,math-calculus-1,微分法,...
question,,,,,math-calculus-q1,C1-A1,関数 f(x) を微分せよ...</code></pre>

            <h6>5. 生成AI活用プロンプト例</h6>
            <p>ChatGPTなどの生成AIを使って、問題のCSVデータを効率的に作成できます。以下のプロンプトテンプレートをコピーし、<code>【】</code>の部分を書き換えて使用してください。</p>

            <div class="prompt-box">
                <h6>プロンプトテンプレート</h6>
                <pre><code># 命令書
あなたは、Webサイトで使われる問題データを作成するアシスタントです。以下の制約条件と入力内容に従って、問題データをCSV形式で出力してください。

# 制約条件
- 出力は必ずCSV形式とします。
- 1行目には必ず以下のヘッダーを出力してください。
row_type,set_id,set_title,set_description,is_math,q_id,q_num,question_text,hint,answer,explanation
- 各行は「問題セットの定義(row_type=set)」か「個別の問題(row_type=question)」のどちらかとします。
- `set_id` と `q_id` は、必ず「半角英数字」と「ハイフン `-`」のみで、他と重複しないユニークなIDを作成してください。
- `is_math`列は、数式を含む場合は `TRUE`、含まない場合は `FALSE` としてください。
- `question_text` や `explanation` 内で改行が必要な場合は、必ず `<br>` タグを使用してください。
- 値の途中でカンマ(`,`)は絶対に使用しないでください。読点には「、」を使用してください。

# 入力内容
- 教科: 【高校化学】
- テーマ: 【酸と塩基、酸化還元反応】
- 作成する問題セット数: 【2】
- 各セットの問題数: 【3】
- set_idの接頭辞: 【chem】
- q_idの接頭辞: 【chem】

# 出力形式の例
row_type,set_id,set_title,...
set,chem-acid-1,酸と塩基,...
question,,,,,chem-acid-q1,問1,pHが3の塩酸を...</code></pre>
            </div>
            
            <div class="warning-box">
                <h6>ベストプラクティスと最重要注意点</h6>
                <p>
                    <strong>⚠️ 値にカンマ(`,`)を使わない:</strong> 問題文や解説文の途中でカンマを使うと、ファイルが壊れる原因になります。読点には必ず「、」を使用してください。<br>
                    <strong>📁 保存形式:</strong> ファイルを保存する際は、必ず **CSV (カンマ区切り)** 形式を選び、文字コードは **UTF-8** で保存してください。<br>
                    <strong>🆔 IDの命名規則:</strong> `set_id`と`q_id`は、ウェブサイトの動作に不可欠です。必ず「半角英数字」と「ハイフン `-`」のみを使い、他と重複しないユニークなIDを付けてください。<br>
                    <strong>🤖 AI利用時の注意:</strong> AIが生成した内容は必ず人間がレビューし、IDの重複や誤情報がないか確認してから使用してください。
                </p>
            </div>
        </main>
        <footer>
            <nav>
                <button class="large" id="close-guide-footer-btn">閉じる</button>
            </nav>
        </footer>
    </dialog>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const dropArea = document.getElementById('drop-area');
        const fileInput = document.getElementById('file-input');
        const fileInfo = document.getElementById('file-info');
        const convertBtn = document.getElementById('convert-btn');
        const downloadBtn = document.getElementById('download-btn');
        const subjectIdInput = document.getElementById('subject-id');
        const subjectTitleInput = document.getElementById('subject-title');
        const jsonOutput = document.getElementById('json-output');

        let selectedFile = null;

        dropArea.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', () => handleFiles(fileInput.files));
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => dropArea.addEventListener(eventName, preventDefaults, false));
        ['dragenter', 'dragover'].forEach(eventName => dropArea.addEventListener(eventName, () => dropArea.classList.add('highlight'), false));
        ['dragleave', 'drop'].forEach(eventName => dropArea.addEventListener(eventName, () => dropArea.classList.remove('highlight'), false));
        dropArea.addEventListener('drop', (e) => handleFiles(e.dataTransfer.files), false);

        function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
        function handleFiles(files) {
            if (files.length > 0) {
                selectedFile = files[0];
                if (selectedFile.type && !selectedFile.type.startsWith('text/csv') && !selectedFile.name.endsWith('.csv')) {
                    alert('CSVファイルを選択してください。');
                    selectedFile = null; fileInput.value = ''; fileInfo.textContent = 'ファイルが選択されていません'; convertBtn.disabled = true; return;
                }
                fileInfo.textContent = `選択中のファイル: ${selectedFile.name}`;
                convertBtn.disabled = false;
            }
        }

        convertBtn.addEventListener('click', () => {
            if (!selectedFile) { alert('ファイルを選択してください。'); return; }
            const subjectId = subjectIdInput.value.trim();
            const subjectTitle = subjectTitleInput.value.trim();
            if (!subjectId || !subjectTitle) { alert('教科IDと教科名を入力してください。'); return; }
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const jsonData = convertCsvToJson(event.target.result, subjectId, subjectTitle);
                    jsonOutput.value = JSON.stringify(jsonData, null, 2);
                    downloadBtn.disabled = false;
                } catch (error) {
                    alert('CSVの変換中にエラーが発生しました。\n' + error.message);
                    jsonOutput.value = ''; downloadBtn.disabled = true;
                }
            };
            reader.readAsText(selectedFile, 'utf-8');
        });
        
        function parseCsv(csvText) {
            const lines = csvText.trim().split(/\r?\n/);
            if (lines.length < 2) return null;
            const header = lines[0].split(',').map(h => h.trim());
            const rows = [];
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                if (values.length === header.length) {
                    const rowObject = {};
                    for (let j = 0; j < header.length; j++) {
                        rowObject[header[j]] = values[j] ? values[j].trim() : '';
                    }
                    rows.push(rowObject);
                }
            }
            return rows;
        }

        function convertCsvToJson(csvText, subjectId, subjectTitle) {
            const dataRows = parseCsv(csvText);
            if (!dataRows) throw new Error('CSVにはヘッダーと少なくとも1行のデータが必要です。');
            const contentSets = [];
            let currentSet = null;
            dataRows.forEach(row => {
                const rowType = row.row_type ? row.row_type.toLowerCase() : '';
                if (rowType === 'set') {
                    if (currentSet) contentSets.push(currentSet);
                    currentSet = { id: row.set_id, title: row.set_title, description: row.set_description, isMath: (row.is_math || '').toUpperCase() === 'TRUE', questions: [] };
                } else if (rowType === 'question' && currentSet) {
                    currentSet.questions.push({ id: row.q_id, q_num: row.q_num, question_text: row.question_text, hint: row.hint, answer: row.answer, explanation: row.explanation });
                }
            });
            if (currentSet) contentSets.push(currentSet);
            return { id: subjectId, title: subjectTitle, contentSets: contentSets };
        }

        downloadBtn.addEventListener('click', () => {
            const jsonString = jsonOutput.value;
            if (!jsonString) return;
            const subjectId = subjectIdInput.value.trim() || 'data';
            const filename = `${subjectId}.json`;
            const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = filename;
            document.body.appendChild(a); a.click();
            document.body.removeChild(a); URL.revokeObjectURL(url);
        });

        const showGuideBtn = document.getElementById('show-guide-btn');
        const guideDialog = document.getElementById('guide-dialog');
        const closeGuideBtn = document.getElementById('close-guide-btn');
        const closeGuideFooterBtn = document.getElementById('close-guide-footer-btn');

        showGuideBtn.addEventListener('click', () => {
            guideDialog.showModal();
        });
        closeGuideBtn.addEventListener('click', () => {
            guideDialog.close();
        });
        closeGuideFooterBtn.addEventListener('click', () => {
            guideDialog.close();
        });
    });
    </script>
</body>
</html>