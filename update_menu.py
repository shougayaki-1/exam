import os
import re

# ==========================================
# è¨­å®šã‚¨ãƒªã‚¢
# ==========================================

# 1. å‡ºåŠ›ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹
OUTPUT_FILE = "js/menu.js"

# 2. ã‚¹ã‚­ãƒ£ãƒ³ã™ã‚‹å¯¾è±¡ã®ãƒ•ã‚©ãƒ«ãƒ€ã¨ã€å¯¾å¿œã™ã‚‹ID
#    "ãƒ•ã‚©ãƒ«ãƒ€å": "IDï¼ˆjs/menu.jsã®subjectSettingsã¨åˆã‚ã›ã‚‹ï¼‰"
TARGET_DIRS = {
    "english": "english",
    "math": "math",
    "kokugo": "kokugo",
    "science": "science",
    "social": "social",
    "info": "info"
}

# 3. é™¤å¤–ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«åï¼ˆå¿…è¦ã§ã‚ã‚Œã°ï¼‰
EXCLUDE_FILES = ["template.html", "index.html"]

# ==========================================
# å‡¦ç†ãƒ­ã‚¸ãƒƒã‚¯
# ==========================================

def get_html_title(file_path):
    """HTMLãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰<title>ã‚¿ã‚°ã®ä¸­èº«ã‚’æŠ½å‡ºã™ã‚‹"""
    try:
        with open(file_path, 'r', encoding='utf-8') as f:
            content = f.read()
            # <title>...</title> ã‚’æ­£è¦è¡¨ç¾ã§æ¢ã™
            match = re.search(r'<title>(.*?)</title>', content, re.IGNORECASE | re.DOTALL)
            if match:
                return match.group(1).strip()
    except Exception as e:
        print(f"Error reading {file_path}: {e}")
    
    # ã‚¿ã‚¤ãƒˆãƒ«ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ãƒ•ã‚¡ã‚¤ãƒ«åã‚’è¿”ã™
    return os.path.basename(file_path)

def generate_menu_js():
    menu_data = []

    print("--- Scanning directories ---")

    # è¨­å®šã•ã‚ŒãŸãƒ•ã‚©ãƒ«ãƒ€ã‚’é †ç•ªã«ã‚¹ã‚­ãƒ£ãƒ³
    for folder, subject_id in TARGET_DIRS.items():
        if not os.path.exists(folder):
            print(f"Skipping missing directory: {folder}")
            continue

        # ãƒ•ã‚©ãƒ«ãƒ€å†…ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èµ°æŸ»
        for filename in os.listdir(folder):
            if filename.endswith(".html") and filename not in EXCLUDE_FILES:
                file_path = os.path.join(folder, filename)
                
                # HTMLã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’å–å¾—
                title = get_html_title(file_path)
                
                # ãƒ‘ã‚¹ã‚’Webç”¨ï¼ˆã‚¹ãƒ©ãƒƒã‚·ãƒ¥åŒºåˆ‡ã‚Šï¼‰ã«å¤‰æ› (Windowså¯¾ç­–)
                web_path = file_path.replace(os.sep, '/')
                
                print(f"Found: [{subject_id}] {title} ({filename})")
                
                # ãƒ‡ãƒ¼ã‚¿ã«è¿½åŠ 
                menu_data.append({
                    "id": subject_id,
                    "title": title,
                    "file": web_path
                })

    # JSãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’ä½œæˆ
    js_content = f"""/* js/menu.js - Auto-generated by Python */

// æ•™ç§‘ã”ã¨ã®è¨­å®š (å›ºå®š)
const subjectSettings = {{
    english: {{ name: "English", icon: "A", colorClass: "subject-english", description: "å˜èªãƒ»é•·æ–‡" }},
    math:    {{ name: "Math",     icon: "âˆ‘", colorClass: "subject-math",    description: "æ•°å­¦Iãƒ»Aãƒ»IIãƒ»B" }},
    kokugo:  {{ name: "å›½èª",      icon: "æ–‡", colorClass: "subject-kokugo",  description: "ç¾ä»£æ–‡ãƒ»å¤æ–‡ãƒ»æ¼¢æ–‡" }},
    science: {{ name: "Science",  icon: "ğŸ§ª", colorClass: "subject-science", description: "ç‰©ç†ãƒ»åŒ–å­¦ãƒ»åœ°å­¦" }},
    social:  {{ name: "Social",   icon: "ğŸ›ï¸", colorClass: "subject-social",  description: "æ­´å²ãƒ»åœ°ç†" }},
    info:    {{ name: "Info",     icon: "ğŸ’»", colorClass: "subject-info",    description: "æƒ…å ±ãƒ»ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°" }}
}};

// è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸãƒšãƒ¼ã‚¸ãƒªã‚¹ãƒˆ
const menuData = {str(menu_data).replace("'", '"')}; // JSONå½¢å¼ã«å¤‰æ›
"""

    # ãƒ•ã‚¡ã‚¤ãƒ«æ›¸ãè¾¼ã¿
    try:
        with open(OUTPUT_FILE, 'w', encoding='utf-8') as f:
            f.write(js_content)
        print(f"\nSuccessfully updated {OUTPUT_FILE}!")
    except Exception as e:
        print(f"Error writing file: {e}")

if __name__ == "__main__":
    generate_menu_js()